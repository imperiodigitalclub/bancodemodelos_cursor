import{r as f,j as t,C as F,L as N,Z as O,D as $,v as q,w as R,x as V,aF as B,G as T,B as S,q as G,aG as Y,aH as U,t as b,bc as W}from"./index-1d87757c.js";import{C as Z}from"./crop-74373485.js";const M=({imagePreview:e,onImageChange:m,userName:_,isEditable:r=!0})=>{const[h,c]=f.useState(!1),[n,d]=f.useState(""),[i,u]=f.useState(),[a,p]=f.useState(null),[g,x]=f.useState(null),[w,k]=f.useState(null),[y,j]=f.useState(!1),I=l=>{if(l.target.files&&l.target.files.length>0){const s=l.target.files[0];k(s),u(void 0);const o=new FileReader;o.addEventListener("load",()=>{var v;d(((v=o.result)==null?void 0:v.toString())||""),c(!0)}),o.readAsDataURL(s),l.target.value=""}},P=l=>{const{width:s,height:o}=l.currentTarget;u(Y(U({unit:"%",width:90},1,s,o),s,o))},E=async(l,s)=>{const o=document.createElement("canvas"),v=l.naturalWidth/l.width,C=l.naturalHeight/l.height;return o.width=s.width,o.height=s.height,o.getContext("2d").drawImage(l,s.x*v,s.y*C,s.width*v,s.height*C,0,0,s.width,s.height),new Promise(L=>{o.toBlob(H=>{L(H)},"image/jpeg",.9)})},X=async()=>{if(!(y||!a||!g||!w)){j(!0);try{const l=await E(g,a);if(l){const s=new File([l],w.name,{type:l.type});m(s)}}catch(l){console.error("Erro ao cortar imagem:",l)}finally{c(!1),j(!1)}}},z=()=>{w&&m(w),c(!1)};return t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[t.jsxs("div",{className:"relative w-32 h-32 md:w-40 md:h-40 group",children:[e?t.jsx("img",{src:e,alt:"Pré-visualização da imagem de perfil",className:"w-full h-full rounded-full object-cover border-4 border-gray-200 group-hover:border-pink-500 transition-colors shadow-md"}):t.jsx("div",{className:"w-full h-full rounded-full bg-gray-100 flex items-center justify-center border-4 border-dashed border-gray-300 group-hover:border-pink-500 transition-colors shadow-sm",children:t.jsx(F,{className:"w-20 h-20 text-gray-400"})}),r&&t.jsx(N,{htmlFor:"profile_image_file_input",className:"absolute inset-0 flex items-center justify-center bg-black bg-opacity-0 group-hover:bg-opacity-50 rounded-full cursor-pointer transition-opacity",children:t.jsx(F,{className:"h-8 w-8 text-white opacity-0 group-hover:opacity-100 transition-opacity"})})]}),r&&t.jsxs(t.Fragment,{children:[t.jsx(O,{id:"profile_image_file_input",name:"profile_image_file",type:"file",onChange:I,accept:"image/*",className:"hidden"}),t.jsx(N,{htmlFor:"profile_image_file_input",className:"text-sm text-pink-600 hover:text-pink-700 cursor-pointer font-medium",children:e?"Alterar Foto de Perfil":"Enviar Foto de Perfil"})]})]}),h&&n&&t.jsx($,{open:h,onOpenChange:()=>{y||c(!1)},children:t.jsxs(q,{className:"max-w-xl",children:[t.jsx(R,{children:t.jsx(V,{children:"Cortar Imagem de Perfil"})}),t.jsx("div",{className:"flex justify-center max-h-[60vh] overflow-auto my-4",children:t.jsx(B,{crop:i,onChange:(l,s)=>u(s),onComplete:l=>p(l),aspect:1,minWidth:100,minHeight:100,circularCrop:!0,children:t.jsx("img",{ref:x,alt:"Cortar imagem",src:n,onLoad:P,style:{maxHeight:"55vh",objectFit:"contain"}})})}),t.jsxs(T,{className:"gap-2 sm:justify-end",children:[t.jsx(S,{variant:"outline",onClick:z,disabled:y,children:"Usar Original"}),t.jsxs(S,{onClick:X,className:"btn-gradient text-white",disabled:y||!a,children:[y?t.jsx(G,{className:"h-4 w-4 animate-spin mr-2"}):t.jsx(Z,{className:"h-4 w-4 mr-2"}),"Cortar e Usar"]})]})]})})]})},Q=(e,m,_)=>{var c,n,d;const r={},h=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if((c=e.first_name)!=null&&c.trim()||(r.first_name="Nome é obrigatório."),(n=e.last_name)!=null&&n.trim()||(r.last_name="Sobrenome é obrigatório."),_==="admin"&&!((d=e.email)!=null&&d.trim())?r.email="E-mail é obrigatório.":_==="admin"&&e.email&&!h.test(e.email)&&(r.email="Formato de e-mail inválido."),e.phone&&!/^\(\d{2}\) \d{5}-\d{4}$/.test(e.phone)&&!/^\d{11}$/.test(e.phone.replace(/\D/g,""))&&(r.phone="Formato de telefone inválido. Use (XX) XXXXX-XXXX."),e.birth_date){const i=new Date(e.birth_date),u=new Date;let a=u.getFullYear()-i.getFullYear();const p=u.getMonth()-i.getMonth();(p<0||p===0&&u.getDate()<i.getDate())&&a--,a<18&&_!=="admin"&&_!=="user_verification"&&(r.birth_date="Você deve ter pelo menos 18 anos.")}else _==="user_verification"&&(r.birth_date="Data de nascimento é obrigatória para verificação.");return e.user_type==="model"&&(e.cache_value&&(isNaN(e.cache_value)||e.cache_value<0)&&(r.cache_value="Valor do cachê inválido."),e.gender||(r.gender="Gênero é obrigatório."),e.model_type||(r.model_type="Tipo de modelo é obrigatório."),e.model_physical_type||(r.model_physical_type="Perfil físico é obrigatório.")),r},D=async({formData:e,currentAuthUser:m,isAdminEditing:_,toast:r,refreshAuthUser:h,onSuccess:c})=>{const n=e.id;if(!n)return r({title:"Erro Crítico",description:"ID do usuário para atualização não foi encontrado. Tente recarregar a página.",variant:"destructive"}),!1;try{let d=e.profile_image_url;if(e.profile_image_file){const a=e.profile_image_file,p=`${n}/profile_images/${Date.now()}_${a.name.replace(/\s/g,"_")}`,{error:g}=await b.storage.from("user_media").upload(p,a,{upsert:!0});if(g)throw g;const{data:x}=b.storage.from("user_media").getPublicUrl(p);d=x.publicUrl}const i={first_name:e.first_name||null,last_name:e.last_name||null,legal_full_name:e.legal_full_name||null,birth_date:e.birth_date||null,display_age:e.display_age?parseInt(e.display_age,10):null,phone:e.phone||null,city:e.city||null,state:e.state||null,bio:e.bio||null,instagram_handle:W(e.instagram_handle_raw),instagram_handle_raw:e.instagram_handle_raw||null,profile_image_url:d,updated_at:new Date().toISOString()};if(!_)i.email=e.email;else if(i.user_type=e.user_type,i.is_verified=e.is_verified||!1,e.is_verified)i.is_identity_verified=!0,i.verification_status="verified_by_admin";else{i.is_identity_verified=!1,i.verification_status="revoked_by_admin";const{data:a,error:p}=await b.from("user_verifications").select("id, status").eq("user_id",n).eq("status","approved").order("requested_at",{ascending:!1}).limit(1).maybeSingle();if(p&&console.error("Error fetching latest verification:",p),a){const{error:g}=await b.from("user_verifications").update({status:"admin_revoked",admin_notes:'Verificação revogada pelo administrador ao desmarcar selo "Verificado" no perfil.'}).eq("id",a.id);g&&(console.error("Error updating verification status to admin_revoked:",g),r({title:"Atenção",description:"Não foi possível atualizar o status da solicitação de verificação anterior.",variant:"warning"}))}}e.user_type==="model"?(i.gender=e.gender||null,i.model_type=e.model_type||null,i.model_physical_type=e.model_physical_type||null,i.model_characteristics=Array.isArray(e.model_characteristics)?e.model_characteristics:[],i.work_interests=Array.isArray(e.work_interests)?e.work_interests:[],i.height=e.height||null,i.weight=e.weight||null,i.hair_color=e.hair_color||null,i.eye_color=e.eye_color||null,i.bust=e.bust||null,i.waist=e.waist||null,i.hips=e.hips||null,i.shoe_size=e.shoe_size||null,i.cache_value=e.cache_value||null,i.company_name=null,i.company_details=null,i.company_website=null):["contractor","photographer","admin"].includes(e.user_type)&&(i.company_name=e.company_name||null,i.company_details=e.company_details||null,i.company_website=e.company_website||null,i.gender=null,i.model_type=null,i.model_physical_type=null,i.model_characteristics=[],i.work_interests=[],i.height=null,i.weight=null,i.hair_color=null,i.eye_color=null,i.bust=null,i.waist=null,i.hips=null,i.shoe_size=null,i.cache_value=null);const{error:u}=await b.from("profiles").update(i).eq("id",n).select();if(u)throw u;return r({title:"Sucesso!",description:"Perfil atualizado."}),(m==null?void 0:m.id)===n&&h?await h(!0):_&&h&&await h(!1),c&&c(),!0}catch(d){return console.error("[ProfileFormHandler] handleSubmit - General error during profile update:",d),r({title:"Erro ao atualizar perfil",description:`Detalhes: ${d.message}`,variant:"destructive"}),!1}};export{M as P,D as h,Q as v};
